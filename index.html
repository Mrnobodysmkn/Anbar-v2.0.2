<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>مدیریت انبار - v9.0</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- CSS تقویم از CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/d-calendar@latest/dist/d-calendar.picker.css">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root {
    --bg-color: #f7f8fa;
    --app-bg: #ffffff;
    --card-bg: #ffffff;
    --text-primary: #1c1c1e;
    --text-secondary: #8a8a8e;
    --accent-blue: #007aff;
    --alert-red: #ff3b30;
    --success-green: #34c759;
    /* --- پالت جدید Claymorphism --- */
    --shadow-light: rgba(255, 255, 255, 0.9);
    --shadow-dark: rgba(174, 174, 192, 0.4);
    --shadow-inset-light: rgba(255, 255, 255, 0.9);
    --shadow-inset-dark: rgba(174, 174, 192, 0.3);
  }
  body {
    background-color: var(--bg-color);
    font-family: 'Vazirmatn', sans-serif;
    color: var(--text-primary);
    padding: 12px;
    overscroll-behavior: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  #app-frame {
    background-color: var(--app-bg);
    border-radius: 40px;
    height: calc(100dvh - 24px);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
  }
  .content-wrapper {
    height: 100%;
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
  }
  
  /* --- طراحی جدید کارت (Clay UI) --- */
  .clay-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
    transition: all 0.2s ease-out;
  }
  .clay-card:active {
    box-shadow: inset 4px 4px 8px var(--shadow-inset-dark), inset -4px -4px 8px var(--shadow-inset-light);
    transform: scale(0.98);
  }
  
  /* --- طراحی جدید دکمه (Clay UI) --- */
  .action-btn {
    position: relative;
    padding: 16px;
    border-radius: 20px;
    font-weight: 600;
    color: var(--text-primary);
    border: none;
    box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
    transform-style: preserve-3d;
    text-align: center;
    font-size: 1.1rem;
    transition: all 0.15s ease-out;
    background: var(--card-bg);
  }
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
  }
  .action-btn:active {
    transform: translateY(1px) scale(0.97);
    box-shadow: inset 4px 4px 8px var(--shadow-inset-dark), inset -4px -4px 8px var(--shadow-inset-light);
  }
  .btn-primary {
    background-image: linear-gradient(135deg, var(--accent-blue), #006ae0);
    color: white;
    box-shadow: 0px 8px 20px rgba(0, 122, 255, 0.3);
  }
  .btn-primary:hover {
     box-shadow: 0px 10px 25px rgba(0, 122, 255, 0.4);
  }
  .btn-primary:active {
    box-shadow: inset 0px 2px 4px rgba(0,0,0,0.2);
    transform: translateY(1px) scale(0.98);
  }
  
  .section-content { display: none; }
  .section-content.active {
      display: block;
      animation: fadeIn 0.4s ease-in-out;
  }
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }

  /* --- استایل فرم‌های ورودی --- */
  .form-input {
    width: 100%;
    background-color: var(--bg-color);
    border: 1px solid rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 14px;
    font-size: 1rem;
    color: var(--text-primary);
    box-shadow: inset 3px 3px 6px var(--shadow-inset-dark), inset -3px -3px 6px var(--shadow-inset-light);
    transition: all 0.2s ease;
    appearance: none;
  }
  .form-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    background-color: #fff;
    box-shadow: 0 0 0 2px var(--accent-blue);
  }
  .form-input-group { position: relative; }
  .form-input-unit {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
  }
  .form-select {
    background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 20 20%22 fill='%238a8a8e'%3E%3Cpath fill-rule=%22evenodd%22 d=%22M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z%22 clip-rule=%22evenodd%22/%3E%3C/svg%3E');
    background-repeat: no-repeat;
    background-position: center left 1rem;
  }

  /* --- استایل اعلان --- */
  #toast {
    visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
    border-radius: 12px; padding: 16px; position: fixed; z-index: 10000; left: 50%; top: 50px;
    transform: translateX(-50%); font-size: 0.95rem; font-weight: 600;
    opacity: 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    transition: visibility 0.5s, opacity 0.5s, top 0.5s cubic-bezier(0.17, 0.67, 0.2, 1.25);
  }
  #toast.show { visibility: visible; opacity: 1; top: 70px; }
  #toast.success { background-color: var(--success-green); }
  #toast.error { background-color: var(--alert-red); color: white; }
  
  /* --- استایل دکمه خروج و آیکون‌ها --- */
  .remove-item-btn {
    font-size: 0.75rem; font-weight: 600; background-color: rgba(255, 59, 48, 0.1); 
    color: var(--alert-red); border: none; padding: 6px 12px;
    border-radius: 10px; transition: all 0.2s;
  }
  .remove-item-btn:hover { background-color: rgba(255, 59, 48, 0.2); }
  .icon-style {
    width: 1.5rem; height: 1.5rem;
    stroke-width: 2;
  }
  
  /* --- استایل صفحه خالی --- */
  .empty-state-container {
    text-align: center; margin-top: 3rem; opacity: 0.7;
    animation: fadeIn 1s ease-in-out;
  }
  .empty-state-container svg {
    width: 6rem; height: 6rem; margin: 0 auto 1rem;
    stroke: var(--text-secondary);
  }
  .empty-state-container p {
    font-size: 1.1rem; font-weight: 600;
    color: var(--text-primary);
  }
  .empty-state-container span {
    font-size: 0.9rem; color: var(--text-secondary);
  }
  
  /* --- استایل بخش بارکد --- */
  #reader {
    width: 100%;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: inset 4px 4px 8px var(--shadow-inset-dark), inset -4px -4px 8px var(--shadow-inset-light);
  }
</style>
</head>
<body>

<div id="toast"></div>

<div id="app-frame">
  <div class="content-wrapper">
    <!-- هدر جدید -->
    <header class="p-6 pt-8">
        <div class="flex justify-between items-center mb-6 px-2">
            <div>
                <h1 class="text-3xl font-bold">انبار من</h1>
                <p id="header-date" class="text-sm text-text-secondary font-medium"></p>
            </div>
            <div class="text-left">
                <span id="app-version" class="text-xs font-semibold text-text-secondary px-3 py-1 bg-gray-200 rounded-full"></span>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto px-6 pb-6">
        <div id="home-screen" class="section-content active">
             <div class="grid grid-cols-1 gap-5">
                <button data-target="dashboard" class="action-btn btn-primary flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                    <span>داشبورد</span>
                </button>
                <button data-target="inventory" class="action-btn flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15v.008" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 7.5h16.5v-1.5c0-.621-.504-1.125-1.125-1.125h-14.25C4.254 4.875 3.75 5.379 3.75 6v1.5z" /></svg>
                    <span>موجودی</span>
                </button>
                <button data-target="add" class="action-btn flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span>افزودن کالا</span>
                </button>
                <div class="grid grid-cols-2 gap-4">
                    <button data-target="scan" class="action-btn flex flex-col items-center justify-center gap-2 text-sm h-28">
                        <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5v15a2.25 2.25 0 002.25 2.25h13.5a2.25 2.25 0 002.25-2.25v-15a2.25 2.25 0 00-2.25-2.25H6a2.25 2.25 0 00-2.25 2.25zM3.75 9h16.5M3.75 15h16.5M7.5 4.5v15m4.5-15v15m4.5-15v15" /></svg>
                        <span>اسکن بارکد</span>
                    </button>
                     <button data-target="import-excel" class="action-btn flex flex-col items-center justify-center gap-2 text-sm h-28">
                        <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span>ورود با اکسل</span>
                    </button>
                </div>
                 <button data-target="report" class="action-btn flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 013 20.625v-7.5zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v12c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 019.75 20.625v-12zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v16.5c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0116.5 20.625v-16.5z" /></svg>
                    <span>گزارش‌گیری</span>
                </button>
            </div>
        </div>
        
        <div data-id="dashboard" class="section-content"></div>
        <div data-id="inventory" class="section-content"></div>
        <div data-id="add" class="section-content"></div>
        <div data-id="scan" class="section-content"></div>
        <div data-id="report" class="section-content"></div>
        <div data-id="import-excel" class="section-content"></div>
        
        <div id="back-button-container" class="mt-6 text-center" style="display: none;">
            <button id="back-to-home" class="action-btn w-full max-w-xs mx-auto">بازگشت به منو</button>
        </div>
    </main>
  </div>
</div>

<!-- کتابخانه‌های جاوااسکریپت از CDN -->
<script src="https://cdn.jsdelivr.net/npm/d-calendar@latest/dist/d-calendar.picker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- منطق اصلی اپلیکیشن -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- نسخه‌بندی ---
    const APP_VERSION = 'v9.0';
    
    // --- DATA MANAGEMENT ---
    const KEY_BATCHES = 'wh_final_batches_v5';
    const KEY_CATEGORIES = 'wh_final_categories_v5';
    let batches = [];
    // --- گروه‌های جدید ---
    let categories = ['شوینده', 'خوراکی', 'نوشیدنی', 'لوازم و ابزار'];
    const units = ['وزن', 'حجم'];
    const excelTemplateHeaders = ['کد کالا', 'نام کالا', 'برند کالا', 'گروه', 'تعداد', 'واحد اندازه‌گیری', 'مقدار کالا', 'تاریخ ورود', 'تاریخ انقضاء', 'توضیحات'];


    function save() {
        localStorage.setItem(KEY_BATCHES, JSON.stringify(batches));
        localStorage.setItem(KEY_CATEGORIES, JSON.stringify(categories));
    }

    function load() {
        batches = JSON.parse(localStorage.getItem(KEY_BATCHES) || '[]');
        const savedCategories = JSON.parse(localStorage.getItem(KEY_CATEGORIES) || 'null');
        if (savedCategories) categories = savedCategories;
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'show ' + type;
        setTimeout(() => { 
            toast.className = toast.className.replace('show', ''); 
        }, 3000);
    }

    // --- UTILITIES ---
    function getJalaliDate() {
        const date = new Date();
        const year = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { year: 'numeric' }).format(date);
        const month = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { month: 'long' }).format(date);
        return `${month} ${year}`;
    }
    
    // --- تابع دقیق‌تر برای تبدیل تاریخ جلالی به میلادی ---
    function parseJalaliDate(jalaliStr) {
        if (!jalaliStr || typeof jalaliStr !== 'string') return null;
        
        // پشتیبانی از هر دو فرمت / و -
        const parts = jalaliStr.split(/[\/-]/); 
        if (parts.length !== 3) return null;
        
        const [year, month, day] = parts.map(Number);
        if (isNaN(year) || isNaN(month) || isNaN(day)) return null;

        // محاسبه تقریبی سال میلادی
        let gYear = year + 621;

        // آرایه روزهای هر ماه جلالی
        const jDaysInMonth = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
        // TODO: برای دقت 100% باید سال کبیسه جلالی هم محاسبه شود
        
        let dayOfYear = 0;
        for (let i = 0; i < month - 1; i++) {
            dayOfYear += jDaysInMonth[i];
        }
        dayOfYear += day;
        
        // تاریخ 1 فروردین آن سال (تقریباً 21 مارس)
        // برای جلوگیری از خطای منطقه زمانی از UTC استفاده می‌کنیم
        let gDate = new Date(Date.UTC(gYear, 2, 21)); // March 21
        
        // اضافه کردن روزهای گذشته از سال جلالی
        gDate.setUTCDate(gDate.getUTCDate() + dayOfYear - 1);
        
        return gDate;
    }
    
    function getTimestamp(jalaliStr) {
        const date = parseJalaliDate(jalaliStr);
        return date ? date.getTime() : null;
    }


    // --- UI NAVIGATION ---
    const homeScreen = document.getElementById('home-screen');
    const backButtonContainer = document.getElementById('back-button-container');
    let html5QrCode = null; // برای نگهداری اسکنر
    
    function showSection(targetId) {
        // --- توقف اسکنر هنگام خروج از صفحه ---
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.log("Gagal stop scanner", err));
            html5QrCode = null;
        }

        homeScreen.classList.remove('active');
        document.querySelectorAll('.section-content[data-id]').forEach(el => el.classList.remove('active'));
        const targetSection = document.querySelector(`.section-content[data-id="${targetId}"]`);
        
        if (targetSection) {
            targetSection.innerHTML = getSectionContent(targetId);
            targetSection.classList.add('active');
            backButtonContainer.style.display = 'block';
            attachEventListeners(targetId);
        }
    }

    function showHomeScreen() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.log("Gagal stop scanner", err));
            html5QrCode = null;
        }
        document.querySelectorAll('.section-content[data-id]').forEach(el => { el.classList.remove('active'); el.innerHTML = ''; });
        homeScreen.classList.add('active');
        backButtonContainer.style.display = 'none';
        updateHeader();
    }

    document.querySelectorAll('.action-btn[data-target]').forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.target)));
    document.getElementById('back-to-home').addEventListener('click', showHomeScreen);

    function getEmptyStateHTML(title, message) {
        return `
            <div class="empty-state-container">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15v.008" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 7.5h16.5v-1.5c0-.621-.504-1.125-1.125-1.125h-14.25C4.254 4.875 3.75 5.379 3.75 6v1.5z" />
                </svg>
                <p class="mt-4">${title}</p>
                <span class="block mt-1">${message}</span>
            </div>
        `;
    }

    // --- DYNAMIC CONTENT ---
    function getSectionContent(sectionId) {
        const commonInputStyle = "form-input";
        const commonSelectStyle = `form-input form-select`;
        const commonButtonStyle = "action-btn btn-primary py-3.5";
        
        const now = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);

        switch(sectionId) {
            case 'dashboard':
                const expiringItems = batches.filter(item => {
                    if (!item.dateExpiryTimestamp) return false;
                    const expiryDate = new Date(item.dateExpiryTimestamp);
                    return expiryDate <= thirtyDaysFromNow && expiryDate >= now;
                }).sort((a,b) => a.dateExpiryTimestamp - b.dateExpiryTimestamp);

                const lowStockItems = batches.filter(item => item.qty <= 5)
                                           .sort((a,b) => a.qty - b.qty);

                if (expiringItems.length === 0 && lowStockItems.length === 0) {
                    return getEmptyStateHTML("داشبورد خلوت است", "هیچ کالایی نزدیک به انقضا یا کمبود موجودی نیست.");
                }

                let expiryHtml = expiringItems.length > 0 ? `
                        <div>
                            <h2 class="text-xl font-bold text-right mb-3">🚨 هشدار انقضا (زیر ۳۰ روز)</h2>
                            <div class="space-y-3">${expiringItems.map(item => `
                                <div class="clay-card p-3 text-right text-sm border-r-4 border-red-500">
                                    <p class="font-bold">${item.title} - <span class="text-red-600">انقضا: ${item.dateExpiry}</span></p>
                                </div>`).join('')}
                            </div>
                        </div>` : '';

                let lowStockHtml = lowStockItems.length > 0 ? `
                        <div>
                            <h2 class="text-xl font-bold text-right mb-3">🛒 پیشنهاد خرید (موجودی کمتر از ۵)</h2>
                            <div class="space-y-3">${lowStockItems.map(item => `
                                <div class="clay-card p-3 text-right text-sm border-r-4 border-yellow-500">
                                    <p class="font-bold">${item.title} - <span class="text-yellow-600">موجودی: ${item.qty}</span></p>
                                </div>`).join('')}
                            </div>
                        </div>` : '';

                return `<div class="space-y-6">${expiryHtml}${lowStockHtml}</div>`;

            case 'inventory':
                 if (batches.length === 0) {
                     return getEmptyStateHTML("انبار شما خالی است", "برای شروع، یک کالا از دکمه «افزودن» ثبت کنید.");
                 }
                return `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-right mb-4">لیست موجودی</h2>
                        ${batches.sort((a, b) => (a.title > b.title) ? 1 : -1).map(item => {
                            const expiryDate = item.dateExpiryTimestamp ? new Date(item.dateExpiryTimestamp) : null;
                            const isExpired = expiryDate && expiryDate < now;
                            const isExpiringSoon = expiryDate && expiryDate < thirtyDaysFromNow;
                            
                            let expiryClass = '';
                            if(isExpired) expiryClass = 'text-gray-500 font-bold';
                            else if(isExpiringSoon) expiryClass = 'text-red-500 font-bold';
                            
                            // --- نمایش واحد و مقدار ---
                            let amountDisplay = '';
                            if (item.unit === 'وزن' && item.amount) amountDisplay = `<span><strong>مقدار:</strong> ${item.amount} کیلوگرم</span>`;
                            if (item.unit === 'حجم' && item.amount) amountDisplay = `<span><strong>مقدار:</strong> ${item.amount} لیتر</span>`;

                            return `
                            <div class="clay-card p-4 text-right ${ isExpired ? 'opacity-60' : ''}">
                                <div class="flex justify-between items-start">
                                  <div>
                                    <p class="font-bold text-lg">${item.title} <span class="text-sm text-text-secondary">${item.brand || ''}</span></p>
                                    ${item.barcode ? `<p class="text-xs text-text-secondary mt-1 font-mono">${item.barcode}</p>` : ''}
                                    <div class="text-sm text-text-secondary mt-3 grid grid-cols-2 gap-2">
                                        <span><strong>دسته:</strong> ${item.category}</span>
                                        <span><strong>تعداد:</strong> ${item.qty}</span>
                                        ${amountDisplay}
                                        <span><strong>ورود:</strong> ${item.dateIn}</span>
                                        ${item.dateExpiry ? `<span class="${expiryClass}"><strong>انقضا:</strong> ${item.dateExpiry}</span>` : ''}
                                    </div>
                                  </div>
                                  <div class="flex-shrink-0">
                                      <button data-id="${item.id}" class="remove-item-btn">ثبت خروج</button>
                                  </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>`;

            case 'add':
                return `
                    <div class="clay-card p-5 space-y-5">
                        <h2 class="text-2xl font-bold text-right">افزودن کالا</h2>
                        <form id="addForm" class="space-y-4">
                            <div><label class="block text-sm font-medium mb-1">کد کالا (اختیاری)</label><input type="text" id="inBarcode" class="${commonInputStyle}" placeholder="بارکد را اسکن کنید یا وارد نمایید"></div>
                            <div><label class="block text-sm font-medium mb-1">نام کالا *</label><input type="text" id="inTitle" class="${commonInputStyle}" required></div>
                            <div><label class="block text-sm font-medium mb-1">برند / مدل</label><input type="text" id="inBrand" class="${commonInputStyle}"></div>
                            <div><label class="block text-sm font-medium mb-1">گروه *</label><select id="inCategory" class="${commonSelectStyle}">${categories.map(c => `<option value="${c}">${c}</option>`).join('')}<option value="add_new">افزودن گروه جدید...</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">تعداد *</label><input type="number" id="inQty" min="1" class="${commonInputStyle}" required></div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">واحد اندازه‌گیری</label>
                                    <select id="inUnit" class="${commonSelectStyle}">
                                        <option value="">ندارد</option>
                                        ${units.map(u => `<option value="${u}">${u}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">مقدار کالا</label>
                                    <div class="form-input-group">
                                        <input type="number" step="0.01" id="inAmount" class="${commonInputStyle}">
                                        <span id="unit-label" class="form-input-unit" style="display: none;"></span>
                                    </div>
                                </div>
                            </div>

                            <div><label class="block text-sm font-medium mb-1">تاریخ ورود *</label><input type="text" id="inDate" class="${commonInputStyle}" readonly required placeholder="روز/ماه/سال"></div>
                            <div><label class="block text-sm font-medium mb-1">تاریخ انقضا</label><input type="text" id="inExpiry" class="${commonInputStyle}" readonly placeholder="روز/ماه/سال"></div>
                            <div><label class="block text-sm font-medium mb-1">توضیحات</label><textarea id="inNote" rows="2" class="${commonInputStyle}"></textarea></div>
                            
                            <div><button type="submit" class="${commonButtonStyle} w-full mt-2">ثبت کالا</button></div>
                        </form>
                    </div>`;
            
            case 'scan':
                return `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-right mb-2">اسکن بارکد</h2>
                        <div id="reader" class="w-full"></div>
                        <p id="scan-status" class="text-center text-text-secondary text-sm">دوربین را به سمت بارکد بگیرید...</p>
                    </div>`;

            case 'import-excel':
                return `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-right mb-2">ورود دسته‌جمعی با اکسل</h2>
                        <div class="clay-card p-5 space-y-4">
                            <p class="text-sm text-text-secondary">برای ورود دسته‌جمعی، ابتدا فایل الگو را دانلود کرده و اطلاعات کالاها را مطابق آن کامل کنید. سپس فایل را بارگذاری نمایید.</p>
                            
                            <button id="download-template" class="${commonButtonStyle} w-full">دانلود فایل الگو (Template)</button>
                            
                            <div class="mt-4">
                                <label for="excel-upload" class="action-btn w-full flex items-center justify-center gap-2 cursor-pointer">
                                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                                    <span>انتخاب فایل اکسل...</span>
                                </label>
                                <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls">
                                <p id="file-name" class="text-center text-sm text-text-secondary mt-2"></p>
                            </div>
                            
                            <button id="process-excel" class="action-btn btn-primary w-full" style="display: none;">بارگذاری و ثبت کالاها</button>
                        </div>
                    </div>`;

            case 'report':
                 if (batches.length === 0) return getEmptyStateHTML("گزارشی برای نمایش وجود ندارد", "ابتدا باید کالایی به انبار اضافه کنید.");
                return `
                    <div class="clay-card p-5 text-center">
                        <h2 class="text-2xl font-bold mb-4">گزارش‌گیری</h2>
                        <p class="text-text-secondary mb-4">این بخش در حال توسعه است و در نسخه‌های آینده فعال خواهد شد.</p>
                    </div>`;
        }
    }

    // --- EVENT LISTENERS & HANDLERS ---
    function attachEventListeners(sectionId) {
        // --- رفع باگ تقویم ---
        if (typeof dCalendar === 'undefined') { 
            console.error("dCalendar library not loaded."); 
        } else {
            if (sectionId === 'add') {
                dCalendar.picker({ target: '#inDate', lang: 'fa', format: 'yyyy/mm/dd' });
                dCalendar.picker({ target: '#inExpiry', lang: 'fa', format: 'yyyy/mm/dd' });
            }
             if (sectionId === 'report' && batches.length > 0) {
                dCalendar.picker({ target: '#repFrom', lang: 'fa', format: 'yyyy/mm/dd' });
                dCalendar.picker({ target: '#repTo', lang: 'fa', format: 'yyyy/mm/dd' });
            }
        }

        if (sectionId === 'add') {
            document.getElementById('addForm').addEventListener('submit', handleAddItem);
            
            // --- منطق نمایش واحد (کیلوگرم/لیتر) ---
            document.getElementById('inUnit').addEventListener('change', (e) => {
                const unitLabel = document.getElementById('unit-label');
                if (e.target.value === 'وزن') {
                    unitLabel.textContent = 'کیلوگرم';
                    unitLabel.style.display = 'block';
                } else if (e.target.value === 'حجم') {
                    unitLabel.textContent = 'لیتر';
                    unitLabel.style.display = 'block';
                } else {
                    unitLabel.style.display = 'none';
                }
            });

            const categorySelect = document.getElementById('inCategory');
            categorySelect.addEventListener('change', () => {
                 if (categorySelect.value === 'add_new') {
                    const newCategory = prompt('نام گروه جدید را وارد کنید:');
                    if (newCategory && newCategory.trim() !== '' && !categories.includes(newCategory)) {
                        categories.push(newCategory.trim()); save();
                        const newOption = new Option(newCategory.trim(), newCategory.trim(), true, true);
                        categorySelect.add(newOption, categorySelect.options[categorySelect.options.length - 1]);
                    } else { categorySelect.selectedIndex = 0; }
                }
            });
        }
        
        if (sectionId === 'inventory') {
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleRemoveItem(e.currentTarget.dataset.id);
                });
            });
        }

        if (sectionId === 'scan') {
            startScanner();
        }

        if (sectionId === 'import-excel') {
            document.getElementById('download-template').addEventListener('click', handleFileDownload);
            const fileInput = document.getElementById('excel-upload');
            const processBtn = document.getElementById('process-excel');
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    document.getElementById('file-name').textContent = fileInput.files[0].name;
                    processBtn.style.display = 'block';
                } else {
                    document.getElementById('file-name').textContent = '';
                    processBtn.style.display = 'none';
                }
            });
            processBtn.addEventListener('click', () => handleFileUpload(fileInput.files[0]));
        }
    }
    
    // --- منطق جدید برای اسکن بارکد ---
    function startScanner() {
        const statusEl = document.getElementById('scan-status');
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            statusEl.textContent = `کد یافت شد: ${decodedText}`;
            html5QrCode.stop();
            html5QrCode = null;
            
            // بررسی موجودی کالا
            const existingItemIndex = batches.findIndex(item => item.barcode === decodedText);
            if (existingItemIndex > -1) {
                // کالا موجود است، ثبت خروج
                handleRemoveItem(batches[existingItemIndex].id, `کالای "${batches[existingItemIndex].title}" یافت شد. `);
            } else {
                // کالا جدید است، انتقال به فرم افزودن
                showSection('add');
                // پیش‌-پر کردن فرم
                setTimeout(() => {
                    document.getElementById('inBarcode').value = decodedText;
                    showToast('کالای جدید اسکن شد. لطفا اطلاعات را تکمیل کنید.', 'success');
                }, 100); // تاخیر کوچک برای اطمینان از رندر شدن فرم
            }
        };

        const qrCodeErrorCallback = (errorMessage) => {
            // console.log(errorMessage);
        };

        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback, qrCodeErrorCallback)
            .catch(err => {
                statusEl.textContent = "خطا در دسترسی به دوربین. لطفا دسترسی بدهید.";
                console.error(err);
            });
    }

    // --- منطق جدید برای دانلود الگو اکسل ---
    function handleFileDownload() {
        const wb = XLSX.utils.book_new();
        const wsData = [excelTemplateHeaders];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Template");
        XLSX.writeFile(wb, "Template-Anbar.xlsx");
        showToast("فایل الگو دانلود شد", "success");
    }

    // --- منطق جدید برای بارگذاری اکسل ---
    function handleFileUpload(file) {
        if (!file) {
            showToast("فایلی انتخاب نشده است", "error");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // خواندن به صورت آرایه

            if (JSON.stringify(jsonData[0]) !== JSON.stringify(excelTemplateHeaders)) {
                showToast("ساختار فایل اکسل با الگو مطابقت ندارد. لطفا فایل الگو را دانلود و استفاده کنید.", "error");
                return;
            }

            const newItems = [];
            const errors = [];
            
            // شروع از ردیف دوم (ایندکس 1) چون ردیف اول هدر است
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row.length === 0) continue; // ردیف خالی

                const newItem = {};
                // نگاشت ستون‌ها بر اساس هدر
                excelTemplateHeaders.forEach((header, index) => {
                    newItem[header] = row[index];
                });

                // --- اعتبارسنجی ---
                if (!newItem['نام کالا'] || !newItem['گروه'] || !newItem['تعداد'] || !newItem['تاریخ ورود']) {
                    errors.push(`ردیف ${i + 1}: فیلدهای اجباری (نام، گروه، تعداد، تاریخ ورود) پر نشده‌اند.`);
                    continue;
                }
                if (!categories.includes(newItem['گروه'])) {
                    errors.push(`ردیف ${i + 1}: گروه "${newItem['گروه']}" نامعتبر است.`);
                    continue;
                }
                if (newItem['واحد اندازه‌گیری'] && !units.includes(newItem['واحد اندازه‌گیری'])) {
                     errors.push(`ردیف ${i + 1}: واحد اندازه‌گیری "${newItem['واحد اندازه‌گیری']}" نامعتبر است (فقط وزن یا حجم).`);
                    continue;
                }

                const dateInTimestamp = getTimestamp(newItem['تاریخ ورود']);
                const dateExpiryTimestamp = getTimestamp(newItem['تاریخ انقضاء']);

                if (!dateInTimestamp) {
                    errors.push(`ردیف ${i + 1}: فرمت تاریخ ورود نامعتبر است (مثال: 1403/01/20).`);
                    continue;
                }
                if (newItem['تاریخ انقضاء'] && !dateExpiryTimestamp) {
                    errors.push(`ردیف ${i + 1}: فرمت تاریخ انقضا نامعتبر است.`);
                    continue;
                }

                newItems.push({
                    id: `id_${Date.now()}_${i}`,
                    barcode: newItem['کد کالا'] || null,
                    title: newItem['نام کالا'],
                    brand: newItem['برند کالا'] || null,
                    category: newItem['گروه'],
                    qty: parseFloat(newItem['تعداد']) || 0,
                    unit: newItem['واحد اندازه‌گیری'] || null,
                    amount: parseFloat(newItem['مقدار کالا']) || null,
                    dateIn: newItem['تاریخ ورود'],
                    dateExpiry: newItem['تاریخ انقضاء'] || null,
                    note: newItem['توضیحات'] || null,
                    dateInTimestamp: dateInTimestamp,
                    dateExpiryTimestamp: dateExpiryTimestamp
                });
            }

            if (errors.length > 0) {
                showToast(`خطا در بارگذاری: ${errors[0]}...`, 'error');
                console.error("خطاهای بارگذاری اکسل:", errors.join("\n"));
            } else {
                batches = [...newItems, ...batches]; // افزودن کالاهای جدید به ابتدای لیست
                save();
                showToast(`${newItems.length} کالا با موفقیت از اکسل اضافه شد.`, 'success');
                showSection('inventory');
            }
        };
        reader.readAsArrayBuffer(file);
    }


    function handleAddItem(e) {
        e.preventDefault();
        
        const dateInStr = document.getElementById('inDate').value;
        const dateExpiryStr = document.getElementById('inExpiry').value || null;
        
        if (!dateInStr) {
            showToast('تاریخ ورود الزامی است', 'error');
            return;
        }

        const dateInTimestamp = getTimestamp(dateInStr);
        const dateExpiryTimestamp = getTimestamp(dateExpiryStr);

        const newItem = {
            id: 'id_' + Date.now(),
            barcode: document.getElementById('inBarcode').value.trim() || null,
            title: document.getElementById('inTitle').value.trim(), 
            brand: document.getElementById('inBrand').value.trim(),
            category: document.getElementById('inCategory').value, 
            qty: parseFloat(document.getElementById('inQty').value) || 0,
            unit: document.getElementById('inUnit').value || null,
            amount: parseFloat(document.getElementById('inAmount').value) || null,
            dateIn: dateInStr, 
            dateExpiry: dateExpiryStr,
            note: document.getElementById('inNote').value.trim(),
            dateInTimestamp: dateInTimestamp,
            dateExpiryTimestamp: dateExpiryTimestamp
        };
        
        batches.unshift(newItem); 
        save();
        showToast('کالا با موفقیت ثبت شد!', 'success');
        showHomeScreen();
    }
    
    function handleRemoveItem(itemId, promptPrefix = '') {
        const itemIndex = batches.findIndex(b => b.id === itemId);
        if (itemIndex === -1) return;
        
        const item = batches[itemIndex];
        const qtyToRemoveStr = prompt(`${promptPrefix}چه تعداد از کالای "${item.title}" خارج/مصرف شد؟\nموجودی فعلی: ${item.qty}`, "1");
        
        if (qtyToRemoveStr === null) return; 
        
        const qtyToRemove = parseFloat(qtyToRemoveStr);
        
        if (isNaN(qtyToRemove) || qtyToRemove <= 0) {
            showToast('لطفا یک عدد معتبر وارد کنید', 'error');
            return;
        }
        
        if (qtyToRemove > item.qty) {
            showToast('تعداد درخواستی از موجودی بیشتر است', 'error');
            return;
        }
        
        item.qty -= qtyToRemove;
        
        if (item.qty === 0) {
            batches.splice(itemIndex, 1);
            showToast(`کالای "${item.title}" به اتمام رسید و از لیست حذف شد.`, 'success');
        } else {
            showToast(`موجودی کالای "${item.title}" به‌روز شد.\nموجودی جدید: ${item.qty}`, 'success');
        }
        
        save();
        showSection('inventory'); 
    }
    
    // --- INITIALIZATION ---
    function updateHeader() { 
        document.getElementById('header-date').textContent = getJalaliDate();
        document.getElementById('app-version').textContent = APP_VERSION;
    }
    load();
    showHomeScreen();
    
});
</script>

<!-- اسکریپت ثبت سرویس ورکر (PWA) -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => console.log('SW registered: ', registration))
                .catch(registrationError => console.log('SW registration failed: ', registrationError));
        });
    }
</script>

</body>
</html>
