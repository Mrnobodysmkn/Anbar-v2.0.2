<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†Ø¨Ø§Ø± - v9.0</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- CSS ØªÙ‚ÙˆÛŒÙ… Ø§Ø² CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/d-calendar@latest/dist/d-calendar.picker.css">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root {
    --bg-color: #f7f8fa;
    --app-bg: #ffffff;
    --card-bg: #ffffff;
    --text-primary: #1c1c1e;
    --text-secondary: #8a8a8e;
    --accent-blue: #007aff;
    --alert-red: #ff3b30;
    --success-green: #34c759;
    /* --- Ù¾Ø§Ù„Øª Ø¬Ø¯ÛŒØ¯ Claymorphism --- */
    --shadow-light: rgba(255, 255, 255, 0.9);
    --shadow-dark: rgba(174, 174, 192, 0.4);
    --shadow-inset-light: rgba(255, 255, 255, 0.9);
    --shadow-inset-dark: rgba(174, 174, 192, 0.3);
  }
  body {
    background-color: var(--bg-color);
    font-family: 'Vazirmatn', sans-serif;
    color: var(--text-primary);
    padding: 12px;
    overscroll-behavior: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  #app-frame {
    background-color: var(--app-bg);
    border-radius: 40px;
    height: calc(100dvh - 24px);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
  }
  .content-wrapper {
    height: 100%;
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
  }
  
  /* --- Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯ Ú©Ø§Ø±Øª (Clay UI) --- */
  .clay-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
    transition: all 0.2s ease-out;
  }
  .clay-card:active {
    box-shadow: inset 4px 4px 8px var(--shadow-inset-dark), inset -4px -4px 8px var(--shadow-inset-light);
    transform: scale(0.98);
  }
  
  /* --- Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ú©Ù…Ù‡ (Clay UI) --- */
  .action-btn {
    position: relative;
    padding: 16px;
    border-radius: 20px;
    font-weight: 600;
    color: var(--text-primary);
    border: none;
    box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
    transform-style: preserve-3d;
    text-align: center;
    font-size: 1.1rem;
    transition: all 0.15s ease-out;
    background: var(--card-bg);
  }
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
  }
  .action-btn:active {
    transform: translateY(1px) scale(0.97);
    box-shadow: inset 4px 4px 8px var(--shadow-inset-dark), inset -4px -4px 8px var(--shadow-inset-light);
  }
  .btn-primary {
    background-image: linear-gradient(135deg, var(--accent-blue), #006ae0);
    color: white;
    box-shadow: 0px 8px 20px rgba(0, 122, 255, 0.3);
  }
  .btn-primary:hover {
     box-shadow: 0px 10px 25px rgba(0, 122, 255, 0.4);
  }
  .btn-primary:active {
    box-shadow: inset 0px 2px 4px rgba(0,0,0,0.2);
    transform: translateY(1px) scale(0.98);
  }
  
  .section-content { display: none; }
  .section-content.active {
      display: block;
      animation: fadeIn 0.4s ease-in-out;
  }
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }

  /* --- Ø§Ø³ØªØ§ÛŒÙ„ ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ --- */
  .form-input {
    width: 100%;
    background-color: var(--bg-color);
    border: 1px solid rgba(0,0,0,0.05);
    border-radius: 12px;
    padding: 14px;
    font-size: 1rem;
    color: var(--text-primary);
    box-shadow: inset 3px 3px 6px var(--shadow-inset-dark), inset -3px -3px 6px var(--shadow-inset-light);
    transition: all 0.2s ease;
    appearance: none;
  }
  .form-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    background-color: #fff;
    box-shadow: 0 0 0 2px var(--accent-blue);
  }
  .form-input-group { position: relative; }
  .form-input-unit {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
  }
  .form-select {
    background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 20 20%22 fill='%238a8a8e'%3E%3Cpath fill-rule=%22evenodd%22 d=%22M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z%22 clip-rule=%22evenodd%22/%3E%3C/svg%3E');
    background-repeat: no-repeat;
    background-position: center left 1rem;
  }

  /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ø¹Ù„Ø§Ù† --- */
  #toast {
    visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
    border-radius: 12px; padding: 16px; position: fixed; z-index: 10000; left: 50%; top: 50px;
    transform: translateX(-50%); font-size: 0.95rem; font-weight: 600;
    opacity: 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    transition: visibility 0.5s, opacity 0.5s, top 0.5s cubic-bezier(0.17, 0.67, 0.2, 1.25);
  }
  #toast.show { visibility: visible; opacity: 1; top: 70px; }
  #toast.success { background-color: var(--success-green); }
  #toast.error { background-color: var(--alert-red); color: white; }
  
  /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬ Ùˆ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ --- */
  .remove-item-btn {
    font-size: 0.75rem; font-weight: 600; background-color: rgba(255, 59, 48, 0.1); 
    color: var(--alert-red); border: none; padding: 6px 12px;
    border-radius: 10px; transition: all 0.2s;
  }
  .remove-item-btn:hover { background-color: rgba(255, 59, 48, 0.2); }
  .icon-style {
    width: 1.5rem; height: 1.5rem;
    stroke-width: 2;
  }
  
  /* --- Ø§Ø³ØªØ§ÛŒÙ„ ØµÙØ­Ù‡ Ø®Ø§Ù„ÛŒ --- */
  .empty-state-container {
    text-align: center; margin-top: 3rem; opacity: 0.7;
    animation: fadeIn 1s ease-in-out;
  }
  .empty-state-container svg {
    width: 6rem; height: 6rem; margin: 0 auto 1rem;
    stroke: var(--text-secondary);
  }
  .empty-state-container p {
    font-size: 1.1rem; font-weight: 600;
    color: var(--text-primary);
  }
  .empty-state-container span {
    font-size: 0.9rem; color: var(--text-secondary);
  }
  
  /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Ø¨Ø§Ø±Ú©Ø¯ --- */
  #reader {
    width: 100%;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: inset 4px 4px 8px var(--shadow-inset-dark), inset -4px -4px 8px var(--shadow-inset-light);
  }
</style>
</head>
<body>

<div id="toast"></div>

<div id="app-frame">
  <div class="content-wrapper">
    <!-- Ù‡Ø¯Ø± Ø¬Ø¯ÛŒØ¯ -->
    <header class="p-6 pt-8">
        <div class="flex justify-between items-center mb-6 px-2">
            <div>
                <h1 class="text-3xl font-bold">Ø§Ù†Ø¨Ø§Ø± Ù…Ù†</h1>
                <p id="header-date" class="text-sm text-text-secondary font-medium"></p>
            </div>
            <div class="text-left">
                <span id="app-version" class="text-xs font-semibold text-text-secondary px-3 py-1 bg-gray-200 rounded-full"></span>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto px-6 pb-6">
        <div id="home-screen" class="section-content active">
             <div class="grid grid-cols-1 gap-5">
                <button data-target="dashboard" class="action-btn btn-primary flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </button>
                <button data-target="inventory" class="action-btn flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15v.008" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 7.5h16.5v-1.5c0-.621-.504-1.125-1.125-1.125h-14.25C4.254 4.875 3.75 5.379 3.75 6v1.5z" /></svg>
                    <span>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</span>
                </button>
                <button data-target="add" class="action-btn flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</span>
                </button>
                <div class="grid grid-cols-2 gap-4">
                    <button data-target="scan" class="action-btn flex flex-col items-center justify-center gap-2 text-sm h-28">
                        <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5v15a2.25 2.25 0 002.25 2.25h13.5a2.25 2.25 0 002.25-2.25v-15a2.25 2.25 0 00-2.25-2.25H6a2.25 2.25 0 00-2.25 2.25zM3.75 9h16.5M3.75 15h16.5M7.5 4.5v15m4.5-15v15m4.5-15v15" /></svg>
                        <span>Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</span>
                    </button>
                     <button data-target="import-excel" class="action-btn flex flex-col items-center justify-center gap-2 text-sm h-28">
                        <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span>ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø§Ú©Ø³Ù„</span>
                    </button>
                </div>
                 <button data-target="report" class="action-btn flex items-center justify-center gap-3">
                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 013 20.625v-7.5zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v12c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 019.75 20.625v-12zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v16.5c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0116.5 20.625v-16.5z" /></svg>
                    <span>Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ</span>
                </button>
            </div>
        </div>
        
        <div data-id="dashboard" class="section-content"></div>
        <div data-id="inventory" class="section-content"></div>
        <div data-id="add" class="section-content"></div>
        <div data-id="scan" class="section-content"></div>
        <div data-id="report" class="section-content"></div>
        <div data-id="import-excel" class="section-content"></div>
        
        <div id="back-button-container" class="mt-6 text-center" style="display: none;">
            <button id="back-to-home" class="action-btn w-full max-w-xs mx-auto">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
        </div>
    </main>
  </div>
</div>

<!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø² CDN -->
<script src="https://cdn.jsdelivr.net/npm/d-calendar@latest/dist/d-calendar.picker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Ù†Ø³Ø®Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ---
    const APP_VERSION = 'v9.0';
    
    // --- DATA MANAGEMENT ---
    const KEY_BATCHES = 'wh_final_batches_v5';
    const KEY_CATEGORIES = 'wh_final_categories_v5';
    let batches = [];
    // --- Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ---
    let categories = ['Ø´ÙˆÛŒÙ†Ø¯Ù‡', 'Ø®ÙˆØ±Ø§Ú©ÛŒ', 'Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ', 'Ù„ÙˆØ§Ø²Ù… Ùˆ Ø§Ø¨Ø²Ø§Ø±'];
    const units = ['ÙˆØ²Ù†', 'Ø­Ø¬Ù…'];
    const excelTemplateHeaders = ['Ú©Ø¯ Ú©Ø§Ù„Ø§', 'Ù†Ø§Ù… Ú©Ø§Ù„Ø§', 'Ø¨Ø±Ù†Ø¯ Ú©Ø§Ù„Ø§', 'Ú¯Ø±ÙˆÙ‡', 'ØªØ¹Ø¯Ø§Ø¯', 'ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ', 'Ù…Ù‚Ø¯Ø§Ø± Ú©Ø§Ù„Ø§', 'ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯', 'ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§Ø¡', 'ØªÙˆØ¶ÛŒØ­Ø§Øª'];


    function save() {
        localStorage.setItem(KEY_BATCHES, JSON.stringify(batches));
        localStorage.setItem(KEY_CATEGORIES, JSON.stringify(categories));
    }

    function load() {
        batches = JSON.parse(localStorage.getItem(KEY_BATCHES) || '[]');
        const savedCategories = JSON.parse(localStorage.getItem(KEY_CATEGORIES) || 'null');
        if (savedCategories) categories = savedCategories;
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'show ' + type;
        setTimeout(() => { 
            toast.className = toast.className.replace('show', ''); 
        }, 3000);
    }

    // --- UTILITIES ---
    function getJalaliDate() {
        const date = new Date();
        const year = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { year: 'numeric' }).format(date);
        const month = new Intl.DateTimeFormat('fa-IR-u-nu-latn', { month: 'long' }).format(date);
        return `${month} ${year}`;
    }
    
    // --- ØªØ§Ø¨Ø¹ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¬Ù„Ø§Ù„ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ ---
    function parseJalaliDate(jalaliStr) {
        if (!jalaliStr || typeof jalaliStr !== 'string') return null;
        
        // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª / Ùˆ -
        const parts = jalaliStr.split(/[\/-]/); 
        if (parts.length !== 3) return null;
        
        const [year, month, day] = parts.map(Number);
        if (isNaN(year) || isNaN(month) || isNaN(day)) return null;

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø³Ø§Ù„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
        let gYear = year + 621;

        // Ø¢Ø±Ø§ÛŒÙ‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡Ø± Ù…Ø§Ù‡ Ø¬Ù„Ø§Ù„ÛŒ
        const jDaysInMonth = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
        // TODO: Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª 100% Ø¨Ø§ÛŒØ¯ Ø³Ø§Ù„ Ú©Ø¨ÛŒØ³Ù‡ Ø¬Ù„Ø§Ù„ÛŒ Ù‡Ù… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯
        
        let dayOfYear = 0;
        for (let i = 0; i < month - 1; i++) {
            dayOfYear += jDaysInMonth[i];
        }
        dayOfYear += day;
        
        // ØªØ§Ø±ÛŒØ® 1 ÙØ±ÙˆØ±Ø¯ÛŒÙ† Ø¢Ù† Ø³Ø§Ù„ (ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ 21 Ù…Ø§Ø±Ø³)
        // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ø² UTC Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        let gDate = new Date(Date.UTC(gYear, 2, 21)); // March 21
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ø§Ø² Ø³Ø§Ù„ Ø¬Ù„Ø§Ù„ÛŒ
        gDate.setUTCDate(gDate.getUTCDate() + dayOfYear - 1);
        
        return gDate;
    }
    
    function getTimestamp(jalaliStr) {
        const date = parseJalaliDate(jalaliStr);
        return date ? date.getTime() : null;
    }


    // --- UI NAVIGATION ---
    const homeScreen = document.getElementById('home-screen');
    const backButtonContainer = document.getElementById('back-button-container');
    let html5QrCode = null; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø§Ø³Ú©Ù†Ø±
    
    function showSection(targetId) {
        // --- ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†Ø± Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÙˆØ¬ Ø§Ø² ØµÙØ­Ù‡ ---
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.log("Gagal stop scanner", err));
            html5QrCode = null;
        }

        homeScreen.classList.remove('active');
        document.querySelectorAll('.section-content[data-id]').forEach(el => el.classList.remove('active'));
        const targetSection = document.querySelector(`.section-content[data-id="${targetId}"]`);
        
        if (targetSection) {
            targetSection.innerHTML = getSectionContent(targetId);
            targetSection.classList.add('active');
            backButtonContainer.style.display = 'block';
            attachEventListeners(targetId);
        }
    }

    function showHomeScreen() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.log("Gagal stop scanner", err));
            html5QrCode = null;
        }
        document.querySelectorAll('.section-content[data-id]').forEach(el => { el.classList.remove('active'); el.innerHTML = ''; });
        homeScreen.classList.add('active');
        backButtonContainer.style.display = 'none';
        updateHeader();
    }

    document.querySelectorAll('.action-btn[data-target]').forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.target)));
    document.getElementById('back-to-home').addEventListener('click', showHomeScreen);

    function getEmptyStateHTML(title, message) {
        return `
            <div class="empty-state-container">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15v.008" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 7.5h16.5v-1.5c0-.621-.504-1.125-1.125-1.125h-14.25C4.254 4.875 3.75 5.379 3.75 6v1.5z" />
                </svg>
                <p class="mt-4">${title}</p>
                <span class="block mt-1">${message}</span>
            </div>
        `;
    }

    // --- DYNAMIC CONTENT ---
    function getSectionContent(sectionId) {
        const commonInputStyle = "form-input";
        const commonSelectStyle = `form-input form-select`;
        const commonButtonStyle = "action-btn btn-primary py-3.5";
        
        const now = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);

        switch(sectionId) {
            case 'dashboard':
                const expiringItems = batches.filter(item => {
                    if (!item.dateExpiryTimestamp) return false;
                    const expiryDate = new Date(item.dateExpiryTimestamp);
                    return expiryDate <= thirtyDaysFromNow && expiryDate >= now;
                }).sort((a,b) => a.dateExpiryTimestamp - b.dateExpiryTimestamp);

                const lowStockItems = batches.filter(item => item.qty <= 5)
                                           .sort((a,b) => a.qty - b.qty);

                if (expiringItems.length === 0 && lowStockItems.length === 0) {
                    return getEmptyStateHTML("Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø®Ù„ÙˆØª Ø§Ø³Øª", "Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø§Ù†Ù‚Ø¶Ø§ ÛŒØ§ Ú©Ù…Ø¨ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†ÛŒØ³Øª.");
                }

                let expiryHtml = expiringItems.length > 0 ? `
                        <div>
                            <h2 class="text-xl font-bold text-right mb-3">ğŸš¨ Ù‡Ø´Ø¯Ø§Ø± Ø§Ù†Ù‚Ø¶Ø§ (Ø²ÛŒØ± Û³Û° Ø±ÙˆØ²)</h2>
                            <div class="space-y-3">${expiringItems.map(item => `
                                <div class="clay-card p-3 text-right text-sm border-r-4 border-red-500">
                                    <p class="font-bold">${item.title} - <span class="text-red-600">Ø§Ù†Ù‚Ø¶Ø§: ${item.dateExpiry}</span></p>
                                </div>`).join('')}
                            </div>
                        </div>` : '';

                let lowStockHtml = lowStockItems.length > 0 ? `
                        <div>
                            <h2 class="text-xl font-bold text-right mb-3">ğŸ›’ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø®Ø±ÛŒØ¯ (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù…ØªØ± Ø§Ø² Ûµ)</h2>
                            <div class="space-y-3">${lowStockItems.map(item => `
                                <div class="clay-card p-3 text-right text-sm border-r-4 border-yellow-500">
                                    <p class="font-bold">${item.title} - <span class="text-yellow-600">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${item.qty}</span></p>
                                </div>`).join('')}
                            </div>
                        </div>` : '';

                return `<div class="space-y-6">${expiryHtml}${lowStockHtml}</div>`;

            case 'inventory':
                 if (batches.length === 0) {
                     return getEmptyStateHTML("Ø§Ù†Ø¨Ø§Ø± Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª", "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø§Ø² Ø¯Ú©Ù…Ù‡ Â«Ø§ÙØ²ÙˆØ¯Ù†Â» Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.");
                 }
                return `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-right mb-4">Ù„ÛŒØ³Øª Ù…ÙˆØ¬ÙˆØ¯ÛŒ</h2>
                        ${batches.sort((a, b) => (a.title > b.title) ? 1 : -1).map(item => {
                            const expiryDate = item.dateExpiryTimestamp ? new Date(item.dateExpiryTimestamp) : null;
                            const isExpired = expiryDate && expiryDate < now;
                            const isExpiringSoon = expiryDate && expiryDate < thirtyDaysFromNow;
                            
                            let expiryClass = '';
                            if(isExpired) expiryClass = 'text-gray-500 font-bold';
                            else if(isExpiringSoon) expiryClass = 'text-red-500 font-bold';
                            
                            // --- Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ø­Ø¯ Ùˆ Ù…Ù‚Ø¯Ø§Ø± ---
                            let amountDisplay = '';
                            if (item.unit === 'ÙˆØ²Ù†' && item.amount) amountDisplay = `<span><strong>Ù…Ù‚Ø¯Ø§Ø±:</strong> ${item.amount} Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</span>`;
                            if (item.unit === 'Ø­Ø¬Ù…' && item.amount) amountDisplay = `<span><strong>Ù…Ù‚Ø¯Ø§Ø±:</strong> ${item.amount} Ù„ÛŒØªØ±</span>`;

                            return `
                            <div class="clay-card p-4 text-right ${ isExpired ? 'opacity-60' : ''}">
                                <div class="flex justify-between items-start">
                                  <div>
                                    <p class="font-bold text-lg">${item.title} <span class="text-sm text-text-secondary">${item.brand || ''}</span></p>
                                    ${item.barcode ? `<p class="text-xs text-text-secondary mt-1 font-mono">${item.barcode}</p>` : ''}
                                    <div class="text-sm text-text-secondary mt-3 grid grid-cols-2 gap-2">
                                        <span><strong>Ø¯Ø³ØªÙ‡:</strong> ${item.category}</span>
                                        <span><strong>ØªØ¹Ø¯Ø§Ø¯:</strong> ${item.qty}</span>
                                        ${amountDisplay}
                                        <span><strong>ÙˆØ±ÙˆØ¯:</strong> ${item.dateIn}</span>
                                        ${item.dateExpiry ? `<span class="${expiryClass}"><strong>Ø§Ù†Ù‚Ø¶Ø§:</strong> ${item.dateExpiry}</span>` : ''}
                                    </div>
                                  </div>
                                  <div class="flex-shrink-0">
                                      <button data-id="${item.id}" class="remove-item-btn">Ø«Ø¨Øª Ø®Ø±ÙˆØ¬</button>
                                  </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>`;

            case 'add':
                return `
                    <div class="clay-card p-5 space-y-5">
                        <h2 class="text-2xl font-bold text-right">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</h2>
                        <form id="addForm" class="space-y-4">
                            <div><label class="block text-sm font-medium mb-1">Ú©Ø¯ Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input type="text" id="inBarcode" class="${commonInputStyle}" placeholder="Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯"></div>
                            <div><label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ú©Ø§Ù„Ø§ *</label><input type="text" id="inTitle" class="${commonInputStyle}" required></div>
                            <div><label class="block text-sm font-medium mb-1">Ø¨Ø±Ù†Ø¯ / Ù…Ø¯Ù„</label><input type="text" id="inBrand" class="${commonInputStyle}"></div>
                            <div><label class="block text-sm font-medium mb-1">Ú¯Ø±ÙˆÙ‡ *</label><select id="inCategory" class="${commonSelectStyle}">${categories.map(c => `<option value="${c}">${c}</option>`).join('')}<option value="add_new">Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯...</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">ØªØ¹Ø¯Ø§Ø¯ *</label><input type="number" id="inQty" min="1" class="${commonInputStyle}" required></div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</label>
                                    <select id="inUnit" class="${commonSelectStyle}">
                                        <option value="">Ù†Ø¯Ø§Ø±Ø¯</option>
                                        ${units.map(u => `<option value="${u}">${u}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Ù…Ù‚Ø¯Ø§Ø± Ú©Ø§Ù„Ø§</label>
                                    <div class="form-input-group">
                                        <input type="number" step="0.01" id="inAmount" class="${commonInputStyle}">
                                        <span id="unit-label" class="form-input-unit" style="display: none;"></span>
                                    </div>
                                </div>
                            </div>

                            <div><label class="block text-sm font-medium mb-1">ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ *</label><input type="text" id="inDate" class="${commonInputStyle}" readonly required placeholder="Ø±ÙˆØ²/Ù…Ø§Ù‡/Ø³Ø§Ù„"></div>
                            <div><label class="block text-sm font-medium mb-1">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</label><input type="text" id="inExpiry" class="${commonInputStyle}" readonly placeholder="Ø±ÙˆØ²/Ù…Ø§Ù‡/Ø³Ø§Ù„"></div>
                            <div><label class="block text-sm font-medium mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª</label><textarea id="inNote" rows="2" class="${commonInputStyle}"></textarea></div>
                            
                            <div><button type="submit" class="${commonButtonStyle} w-full mt-2">Ø«Ø¨Øª Ú©Ø§Ù„Ø§</button></div>
                        </form>
                    </div>`;
            
            case 'scan':
                return `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-right mb-2">Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</h2>
                        <div id="reader" class="w-full"></div>
                        <p id="scan-status" class="text-center text-text-secondary text-sm">Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø³Ù…Øª Ø¨Ø§Ø±Ú©Ø¯ Ø¨Ú¯ÛŒØ±ÛŒØ¯...</p>
                    </div>`;

            case 'import-excel':
                return `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-right mb-2">ÙˆØ±ÙˆØ¯ Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ Ø¨Ø§ Ø§Ú©Ø³Ù„</h2>
                        <div class="clay-card p-5 space-y-4">
                            <p class="text-sm text-text-secondary">Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒØŒ Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ Ø§Ù„Ú¯Ùˆ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù‡ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù„Ø§Ù‡Ø§ Ø±Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ø¢Ù† Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯. Ø³Ù¾Ø³ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
                            
                            <button id="download-template" class="${commonButtonStyle} w-full">Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ù„Ú¯Ùˆ (Template)</button>
                            
                            <div class="mt-4">
                                <label for="excel-upload" class="action-btn w-full flex items-center justify-center gap-2 cursor-pointer">
                                    <svg class="icon-style" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                                    <span>Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„...</span>
                                </label>
                                <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls">
                                <p id="file-name" class="text-center text-sm text-text-secondary mt-2"></p>
                            </div>
                            
                            <button id="process-excel" class="action-btn btn-primary w-full" style="display: none;">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø«Ø¨Øª Ú©Ø§Ù„Ø§Ù‡Ø§</button>
                        </div>
                    </div>`;

            case 'report':
                 if (batches.length === 0) return getEmptyStateHTML("Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", "Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù„Ø§ÛŒÛŒ Ø¨Ù‡ Ø§Ù†Ø¨Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.");
                return `
                    <div class="clay-card p-5 text-center">
                        <h2 class="text-2xl font-bold mb-4">Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ</h2>
                        <p class="text-text-secondary mb-4">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª Ùˆ Ø¯Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
                    </div>`;
        }
    }

    // --- EVENT LISTENERS & HANDLERS ---
    function attachEventListeners(sectionId) {
        // --- Ø±ÙØ¹ Ø¨Ø§Ú¯ ØªÙ‚ÙˆÛŒÙ… ---
        if (typeof dCalendar === 'undefined') { 
            console.error("dCalendar library not loaded."); 
        } else {
            if (sectionId === 'add') {
                dCalendar.picker({ target: '#inDate', lang: 'fa', format: 'yyyy/mm/dd' });
                dCalendar.picker({ target: '#inExpiry', lang: 'fa', format: 'yyyy/mm/dd' });
            }
             if (sectionId === 'report' && batches.length > 0) {
                dCalendar.picker({ target: '#repFrom', lang: 'fa', format: 'yyyy/mm/dd' });
                dCalendar.picker({ target: '#repTo', lang: 'fa', format: 'yyyy/mm/dd' });
            }
        }

        if (sectionId === 'add') {
            document.getElementById('addForm').addEventListener('submit', handleAddItem);
            
            // --- Ù…Ù†Ø·Ù‚ Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ø­Ø¯ (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…/Ù„ÛŒØªØ±) ---
            document.getElementById('inUnit').addEventListener('change', (e) => {
                const unitLabel = document.getElementById('unit-label');
                if (e.target.value === 'ÙˆØ²Ù†') {
                    unitLabel.textContent = 'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…';
                    unitLabel.style.display = 'block';
                } else if (e.target.value === 'Ø­Ø¬Ù…') {
                    unitLabel.textContent = 'Ù„ÛŒØªØ±';
                    unitLabel.style.display = 'block';
                } else {
                    unitLabel.style.display = 'none';
                }
            });

            const categorySelect = document.getElementById('inCategory');
            categorySelect.addEventListener('change', () => {
                 if (categorySelect.value === 'add_new') {
                    const newCategory = prompt('Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
                    if (newCategory && newCategory.trim() !== '' && !categories.includes(newCategory)) {
                        categories.push(newCategory.trim()); save();
                        const newOption = new Option(newCategory.trim(), newCategory.trim(), true, true);
                        categorySelect.add(newOption, categorySelect.options[categorySelect.options.length - 1]);
                    } else { categorySelect.selectedIndex = 0; }
                }
            });
        }
        
        if (sectionId === 'inventory') {
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleRemoveItem(e.currentTarget.dataset.id);
                });
            });
        }

        if (sectionId === 'scan') {
            startScanner();
        }

        if (sectionId === 'import-excel') {
            document.getElementById('download-template').addEventListener('click', handleFileDownload);
            const fileInput = document.getElementById('excel-upload');
            const processBtn = document.getElementById('process-excel');
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    document.getElementById('file-name').textContent = fileInput.files[0].name;
                    processBtn.style.display = 'block';
                } else {
                    document.getElementById('file-name').textContent = '';
                    processBtn.style.display = 'none';
                }
            });
            processBtn.addEventListener('click', () => handleFileUpload(fileInput.files[0]));
        }
    }
    
    // --- Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯ ---
    function startScanner() {
        const statusEl = document.getElementById('scan-status');
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            statusEl.textContent = `Ú©Ø¯ ÛŒØ§ÙØª Ø´Ø¯: ${decodedText}`;
            html5QrCode.stop();
            html5QrCode = null;
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ù„Ø§
            const existingItemIndex = batches.findIndex(item => item.barcode === decodedText);
            if (existingItemIndex > -1) {
                // Ú©Ø§Ù„Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØŒ Ø«Ø¨Øª Ø®Ø±ÙˆØ¬
                handleRemoveItem(batches[existingItemIndex].id, `Ú©Ø§Ù„Ø§ÛŒ "${batches[existingItemIndex].title}" ÛŒØ§ÙØª Ø´Ø¯. `);
            } else {
                // Ú©Ø§Ù„Ø§ Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªØŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù†
                showSection('add');
                // Ù¾ÛŒØ´â€Œ-Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù…
                setTimeout(() => {
                    document.getElementById('inBarcode').value = decodedText;
                    showToast('Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø³Ú©Ù† Ø´Ø¯. Ù„Ø·ÙØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯.', 'success');
                }, 100); // ØªØ§Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±Ù†Ø¯Ø± Ø´Ø¯Ù† ÙØ±Ù…
            }
        };

        const qrCodeErrorCallback = (errorMessage) => {
            // console.log(errorMessage);
        };

        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback, qrCodeErrorCallback)
            .catch(err => {
                statusEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†. Ù„Ø·ÙØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.";
                console.error(err);
            });
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù„Ú¯Ùˆ Ø§Ú©Ø³Ù„ ---
    function handleFileDownload() {
        const wb = XLSX.utils.book_new();
        const wsData = [excelTemplateHeaders];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Template");
        XLSX.writeFile(wb, "Template-Anbar.xlsx");
        showToast("ÙØ§ÛŒÙ„ Ø§Ù„Ú¯Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯", "success");
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ú©Ø³Ù„ ---
    function handleFileUpload(file) {
        if (!file) {
            showToast("ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª", "error");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Ø®ÙˆØ§Ù†Ø¯Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ø¢Ø±Ø§ÛŒÙ‡

            if (JSON.stringify(jsonData[0]) !== JSON.stringify(excelTemplateHeaders)) {
                showToast("Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ø§ Ø§Ù„Ú¯Ùˆ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§ ÙØ§ÛŒÙ„ Ø§Ù„Ú¯Ùˆ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", "error");
                return;
            }

            const newItems = [];
            const errors = [];
            
            // Ø´Ø±ÙˆØ¹ Ø§Ø² Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ… (Ø§ÛŒÙ†Ø¯Ú©Ø³ 1) Ú†ÙˆÙ† Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ Ù‡Ø¯Ø± Ø§Ø³Øª
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row.length === 0) continue; // Ø±Ø¯ÛŒÙ Ø®Ø§Ù„ÛŒ

                const newItem = {};
                // Ù†Ú¯Ø§Ø´Øª Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‡Ø¯Ø±
                excelTemplateHeaders.forEach((header, index) => {
                    newItem[header] = row[index];
                });

                // --- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ---
                if (!newItem['Ù†Ø§Ù… Ú©Ø§Ù„Ø§'] || !newItem['Ú¯Ø±ÙˆÙ‡'] || !newItem['ØªØ¹Ø¯Ø§Ø¯'] || !newItem['ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯']) {
                    errors.push(`Ø±Ø¯ÛŒÙ ${i + 1}: ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ (Ù†Ø§Ù…ØŒ Ú¯Ø±ÙˆÙ‡ØŒ ØªØ¹Ø¯Ø§Ø¯ØŒ ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯) Ù¾Ø± Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.`);
                    continue;
                }
                if (!categories.includes(newItem['Ú¯Ø±ÙˆÙ‡'])) {
                    errors.push(`Ø±Ø¯ÛŒÙ ${i + 1}: Ú¯Ø±ÙˆÙ‡ "${newItem['Ú¯Ø±ÙˆÙ‡']}" Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.`);
                    continue;
                }
                if (newItem['ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ'] && !units.includes(newItem['ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ'])) {
                     errors.push(`Ø±Ø¯ÛŒÙ ${i + 1}: ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ "${newItem['ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ']}" Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (ÙÙ‚Ø· ÙˆØ²Ù† ÛŒØ§ Ø­Ø¬Ù…).`);
                    continue;
                }

                const dateInTimestamp = getTimestamp(newItem['ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯']);
                const dateExpiryTimestamp = getTimestamp(newItem['ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§Ø¡']);

                if (!dateInTimestamp) {
                    errors.push(`Ø±Ø¯ÛŒÙ ${i + 1}: ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ù…Ø«Ø§Ù„: 1403/01/20).`);
                    continue;
                }
                if (newItem['ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§Ø¡'] && !dateExpiryTimestamp) {
                    errors.push(`Ø±Ø¯ÛŒÙ ${i + 1}: ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.`);
                    continue;
                }

                newItems.push({
                    id: `id_${Date.now()}_${i}`,
                    barcode: newItem['Ú©Ø¯ Ú©Ø§Ù„Ø§'] || null,
                    title: newItem['Ù†Ø§Ù… Ú©Ø§Ù„Ø§'],
                    brand: newItem['Ø¨Ø±Ù†Ø¯ Ú©Ø§Ù„Ø§'] || null,
                    category: newItem['Ú¯Ø±ÙˆÙ‡'],
                    qty: parseFloat(newItem['ØªØ¹Ø¯Ø§Ø¯']) || 0,
                    unit: newItem['ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ'] || null,
                    amount: parseFloat(newItem['Ù…Ù‚Ø¯Ø§Ø± Ú©Ø§Ù„Ø§']) || null,
                    dateIn: newItem['ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯'],
                    dateExpiry: newItem['ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§Ø¡'] || null,
                    note: newItem['ØªÙˆØ¶ÛŒØ­Ø§Øª'] || null,
                    dateInTimestamp: dateInTimestamp,
                    dateExpiryTimestamp: dateExpiryTimestamp
                });
            }

            if (errors.length > 0) {
                showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${errors[0]}...`, 'error');
                console.error("Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ú©Ø³Ù„:", errors.join("\n"));
            } else {
                batches = [...newItems, ...batches]; // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù„ÛŒØ³Øª
                save();
                showToast(`${newItems.length} Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø§Ú©Ø³Ù„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`, 'success');
                showSection('inventory');
            }
        };
        reader.readAsArrayBuffer(file);
    }


    function handleAddItem(e) {
        e.preventDefault();
        
        const dateInStr = document.getElementById('inDate').value;
        const dateExpiryStr = document.getElementById('inExpiry').value || null;
        
        if (!dateInStr) {
            showToast('ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
            return;
        }

        const dateInTimestamp = getTimestamp(dateInStr);
        const dateExpiryTimestamp = getTimestamp(dateExpiryStr);

        const newItem = {
            id: 'id_' + Date.now(),
            barcode: document.getElementById('inBarcode').value.trim() || null,
            title: document.getElementById('inTitle').value.trim(), 
            brand: document.getElementById('inBrand').value.trim(),
            category: document.getElementById('inCategory').value, 
            qty: parseFloat(document.getElementById('inQty').value) || 0,
            unit: document.getElementById('inUnit').value || null,
            amount: parseFloat(document.getElementById('inAmount').value) || null,
            dateIn: dateInStr, 
            dateExpiry: dateExpiryStr,
            note: document.getElementById('inNote').value.trim(),
            dateInTimestamp: dateInTimestamp,
            dateExpiryTimestamp: dateExpiryTimestamp
        };
        
        batches.unshift(newItem); 
        save();
        showToast('Ú©Ø§Ù„Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
        showHomeScreen();
    }
    
    function handleRemoveItem(itemId, promptPrefix = '') {
        const itemIndex = batches.findIndex(b => b.id === itemId);
        if (itemIndex === -1) return;
        
        const item = batches[itemIndex];
        const qtyToRemoveStr = prompt(`${promptPrefix}Ú†Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø² Ú©Ø§Ù„Ø§ÛŒ "${item.title}" Ø®Ø§Ø±Ø¬/Ù…ØµØ±Ù Ø´Ø¯ØŸ\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: ${item.qty}`, "1");
        
        if (qtyToRemoveStr === null) return; 
        
        const qtyToRemove = parseFloat(qtyToRemoveStr);
        
        if (isNaN(qtyToRemove) || qtyToRemove <= 0) {
            showToast('Ù„Ø·ÙØ§ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
            return;
        }
        
        if (qtyToRemove > item.qty) {
            showToast('ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨ÛŒØ´ØªØ± Ø§Ø³Øª', 'error');
            return;
        }
        
        item.qty -= qtyToRemove;
        
        if (item.qty === 0) {
            batches.splice(itemIndex, 1);
            showToast(`Ú©Ø§Ù„Ø§ÛŒ "${item.title}" Ø¨Ù‡ Ø§ØªÙ…Ø§Ù… Ø±Ø³ÛŒØ¯ Ùˆ Ø§Ø² Ù„ÛŒØ³Øª Ø­Ø°Ù Ø´Ø¯.`, 'success');
        } else {
            showToast(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ù„Ø§ÛŒ "${item.title}" Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯.\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: ${item.qty}`, 'success');
        }
        
        save();
        showSection('inventory'); 
    }
    
    // --- INITIALIZATION ---
    function updateHeader() { 
        document.getElementById('header-date').textContent = getJalaliDate();
        document.getElementById('app-version').textContent = APP_VERSION;
    }
    load();
    showHomeScreen();
    
});
</script>

<!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø«Ø¨Øª Ø³Ø±ÙˆÛŒØ³ ÙˆØ±Ú©Ø± (PWA) -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => console.log('SW registered: ', registration))
                .catch(registrationError => console.log('SW registration failed: ', registrationError));
        });
    }
</script>

</body>
</html>
